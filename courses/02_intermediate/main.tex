% !TeX program = xelatex

% Create command `createHandout` only if it doesn't already exists.
% To compile in presentation mode, pass a command createHandout doing nothing.
\providecommand{\createHandout}{handout}

\documentclass[
    aspectratio=169,
    \createHandout
]{beamer}

\usepackage{minted}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage{graphicx}
\usepackage{fontspec}
\usepackage{tabularray}

% allow to look for themes in another folder
% https://tex.stackexchange.com/a/284157/301699
\makeatletter
\def\beamer@calltheme#1#2#3{%
    \def\beamer@themelist{#2}
    \@for\beamer@themename:=\beamer@themelist\do
    {\usepackage[{#1}]{\beamer@themelocation/#3\beamer@themename}}}

\def\usefolder#1{
    \def\beamer@themelocation{#1}
}
\def\beamer@themelocation{}
\makeatother

\usefolder{..}
\usetheme{cexa-kokkos}

\AtBeginSection{
    \begin{frame}{Outline}
        \tableofcontents[currentsection, hideothersubsections]
    \end{frame}
}

\AtBeginSubsection{
    \begin{frame}{Outline}
        \tableofcontents[currentsection, currentsubsection]
    \end{frame}
}

\setminted{
    autogobble,
    fontsize=\small,
    bgcolor=lightgray,
    xleftmargin=0.5em,
    xrightmargin=0.5em,
    breaklines,
}

\NewTblrTheme{kokkostable}{
    \SetTblrInner{
        width=\linewidth,
        rowhead=1,
        rows={ht=\baselineskip},
        row{odd}={bg=lightgray},
        row{1}={bg=lightmain},
    }
}

\graphicspath{{../../images/}}

%Information to be included in the title page:
\title{Kokkos intermediate course}
\author{The CExA team}
\institute{CEA}
\date{\today}
\titlegraphic{%
    \includegraphics[height=4em]{kokkos.png}%
    \hspace{1em}%
    \includegraphics[height=4em]{cexa_logo.png}
}

% _____________________________________________________________________________

\begin{document}

\begin{frame}[plain]
    \titlepage
\end{frame}

% _____________________________________________________________________________

\begin{frame}{This course is open source}
    \begin{center}
        \githublink{\url{https://github.com/CExA-project/cexa-kokkos-tutorials}}
    \end{center}
\end{frame}

% _____________________________________________________________________________

\begin{frame}{Prerequisites}
    This course is intended for developers who have have followed the basic course of the tutorials

    \vspace{1em}

    \begin{block}{What you still need}
        \begin{itemize}
            \item Basic knowledge of C/C++
            \item Basic knowledge of parallel programming
            \item Basic knowledge of CMake
            \item Basic knowledge of a Linux environment
            \item Basic knowledge of Kokkos
        \end{itemize}
    \end{block}
\end{frame}

% _____________________________________________________________________________

\begin{frame}{Duration of the course}
    \begin{itemize}
        \item Course + practical work: full day
        \item Course + corrected exercise: half day
        \item Short version: 3 hours
    \end{itemize}
\end{frame}

\begin{frame}{Outline}
    \tableofcontents[hidesubsections]
\end{frame}

% _____________________________________________________________________________

\section{Profiling and debugging}

% _____________________________________________________________________________

\begin{frame}{Profiling and debugging tools at hand}
    \begin{columns}[T]
        \begin{column}{0.33\linewidth}
            Kokkos

            \begin{itemize}
                \item KokkosP interface
                \item Regions
            \end{itemize}

            \vspace{1em}

            \structure{Note:} Not actual tools, but used by tools of the two other categories
        \end{column}
        \begin{column}{0.33\linewidth}
            Kokkos tools

            \begin{itemize}
                \item Kernel timer
                \item Kernel logger
                \item Memory usage
                \item Memory events
                \item Space time stack
            \end{itemize}
        \end{column}
        \begin{column}{0.33\linewidth}
            Third-party tools

            \begin{itemize}
                \item VTune
                \item Nsight Systems
                \item Nsight Compute
                \item Tau
                \item Timemory
                \item Caliper
                \item HPCToolkit
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{KokkosP interface}
    \begin{columns}
        \begin{column}{0.5\linewidth}
            \begin{minted}{C++}
                Kokkos::parallel_for(
                    "initialize A",
                    N,
                    KOKKOS_LAMBDA(int i) {
                        // ...
                    }
                );

                Kokkos::fence(
                    "wait for initialize A"
                );
            \end{minted}
        \end{column}
        \begin{column}{0.5\linewidth}
            \begin{itemize}
                \item Provided by Kokkos
                \item Hooks
                \begin{itemize}
                    \item Parallel constructs
                    \item Fences
                \end{itemize}
                \item Designed for other tools to use it
                \item Always available
                \item No overhead if no tools are used
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{Regions}
    \begin{columns}
        \begin{column}{0.5\linewidth}
            \begin{minted}{C++}
                Kokkos::Profiling::pushRegion(
                    "initialization"
                );

                // ...

                Kokkos::Profiling::popRegion();
            \end{minted}
        \end{column}
        \begin{column}{0.5\linewidth}
            \begin{itemize}
                \item Provided by Kokkos
                \item Set regions of interest in your code
                \item Provided by Kokkos
                \item No specific header needed
                \item Namespace \texttt{Kokkos::Profiling}
                \item \texttt{pushRegion} and \texttt{popRegion} to create a region
                \item Regions can be nested
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

% _____________________________________________________________________________

\begin{frame}{Kokkos tools}
    \begin{itemize}
        \item \githublink{\url{https://github.com/kokkos/kokkos-tools}}
        \item Has a different version number than Kokkos
        \item Should be built and installed somewhere (this requires to install Kokkos too)
        \item Use one tool at a time with the environment variable \texttt{KOKKOS\_TOOLS\_LIB}
        \item Do not ship it within your program (this is a dev tool!)
    \end{itemize}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{Kernel timer for a basic profiling}
    \begin{columns}
        \begin{column}{0.6\linewidth}
            \begin{minted}[breakafter=/]{sh}
                export KOKKOS_TOOLS_LIBS=/absolute/path/to/libkp_kernel_timer.so

                ./my_program
                kp_reader ./name_of_report.dat
            \end{minted}
        \end{column}
        \begin{column}{0.4\linewidth}
            \begin{itemize}
                \item Simple tool for a basic timing analysis
                \item Export environment variable to use the tool
                \item Run the program as usual
                \item Analyze the generated data with the provided \texttt{kp\_reader} program
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{Kernel timer output}
    \begin{minted}[fontsize=\scriptsize,breaklines=false]{text}
         (Type)   Total Time, Call Count, Avg. Time per Call, %Total Time in Kernels, %Total Program Time
        -------------------------------------------------------------------------
        Regions:
        ...
        -------------------------------------------------------------------------
        Kernels:
        ...
        -------------------------------------------------------------------------
        Summary:

        Total Execution Time (incl. Kokkos + non-Kokkos):                   0.20500 seconds
        Total Time in Kokkos kernels:                                       0.11500 seconds
        -> Time outside Kokkos kernels:                                  0.09000 seconds
        -> Percentage in Kokkos kernels:                                   55.98 %
        Total Calls to Kokkos Kernels:                                            3

        -------------------------------------------------------------------------
    \end{minted}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{Kernel timer output (for regions)}
    \begin{minted}[fontsize=\scriptsize,breaklines=false]{text}
         (Type)   Total Time, Call Count, Avg. Time per Call, %Total Time in Kernels, %Total Program Time
        -------------------------------------------------------------------------

        Regions:

        - mirror and copy
        (REGION)   0.092400 1 0.092400 80.448319 45.038345
        - initialization
        (REGION)   0.051400 1 0.051400 44.748858 25.052289
    \end{minted}

    \begin{itemize}
    	\item Regions are named after what you set in \texttt{pushRegion}
    	\item One set of two lines per region
    \end{itemize}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{Kernel timer output (for kernels)}
    \begin{minted}[fontsize=\scriptsize,breaklines=false]{text}
         (Type)   Total Time, Call Count, Avg. Time per Call, %Total Time in Kernels, %Total Program Time

        -------------------------------------------------------------------------
        Kernels:

        - Kokkos::View::initialization [vector_mirror] via memset
        (ParFor)   0.064600 1 0.064600 56.226650 31.478039
        - Initialize
        (ParFor)   0.048400 1 0.048400 42.133665 23.588194
        - Kokkos::View::initialization [vector] via memset
        (ParFor)   0.001900 1 0.001900 1.639685 0.917964
    \end{minted}

    \begin{itemize}
	    \item Kernels are named after what you set in \texttt{parallel\_*}, or have default names
        \item Some internal kernels are visible
	    \item One set of two lines per kernel
    \end{itemize}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{Kernel logger for a basic debugging}
    \begin{columns}
        \begin{column}{0.6\linewidth}
            \begin{minted}[breakafter=/]{sh}
                export KOKKOS_TOOLS_LIBS=/absolute/path/to/libkp_kernel_logger.so

                ./my_program
            \end{minted}
        \end{column}
        \begin{column}{0.4\linewidth}
            \begin{itemize}
                \item Simple tool for a basic timing analysis
                \item Export environment variable to use the tool
                \item Run the program as usual
                \item Analyze the generated data with the provided \texttt{kp\_reader} program
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

% _____________________________________________________________________________

\begin{frame}[fragile]{NVTX connector for NVIDIA tools}
    \begin{columns}
        \begin{column}{0.6\linewidth}
            \begin{minted}[breakafter=/]{sh}
                export KOKKOS_TOOLS_LIBS=/absolute/path/to/libkp_nvtx_connector.so

                # nsight systems
                nsys profile -o report ./my_program
                nsys-ui report.nsys-rep

                # nsight compute
                ncu -o report ./my_program
                ncu-ui report.ncu-rep
            \end{minted}
        \end{column}
        \begin{column}{0.4\linewidth}
            \begin{itemize}
                \item Simple tool to convert Kokkos named regions/kernels into NVTX regions for NVIDIA tools
                \begin{itemize}
                    \item Nsight Systems
                    \item Nsight Compute
                \end{itemize}
                \item Export environment variable to use the tool
                \item Run the program as usual
                \item Open the generated report in either tool
            \end{itemize}
        \end{column}
    \end{columns}
\end{frame}

\begin{frame}{Display NVTX name of kernels in Nsight Systems}
    \begin{columns}
        \begin{column}{0.5\linewidth}
            \begin{enumerate}
                \item Tools $\rightarrow$ Options
                \item Behavior $\rightarrow$ Report
                \item Set "Rename CUDA Kernels by NVTX" to \emph{Yes}
                \item Re-open the report
            \end{enumerate}
        \end{column}
        \begin{column}{0.5\linewidth}
            \includegraphics[width=\linewidth]{nsight_systems_options}
        \end{column}
    \end{columns}
\end{frame}

% _____________________________________________________________________________

\section{Subviews}

% _____________________________________________________________________________

\section{Atomics}

% _____________________________________________________________________________

\section{Layouts}

% _____________________________________________________________________________

\section{Subviews}

% _____________________________________________________________________________

\section{Scatter Views}

\end{document}
